tinymce.PluginManager.add("wpeditimage",function(e){function t(t){return t.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(t,a,n){var i,o,c,d,r,s,l=tinymce.trim;return i=a.match(/id=['"]([^'"]*)['"] ?/),i&&(a=a.replace(i[0],"")),o=a.match(/align=['"]([^'"]*)['"] ?/),o&&(a=a.replace(o[0],"")),c=a.match(/class=['"]([^'"]*)['"] ?/),c&&(a=a.replace(c[0],"")),s=a.match(/width=['"]([0-9]*)['"] ?/),s&&(a=a.replace(s[0],"")),n=l(n),r=n.match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i),r&&r[2]?(d=l(r[2]),r=l(r[1])):(d=l(a).replace(/caption=['"]/,"").replace(/['"]$/,""),r=n),i=i&&i[1]?i[1].replace(/[<>&]+/g,""):"",o=o&&o[1]?o[1]:"alignnone",c=c&&c[1]?" "+c[1].replace(/[<>&]+/g,""):"",!s&&r&&(s=r.match(/width=['"]([0-9]*)['"]/)),s&&s[1]&&(s=s[1]),s&&d?(s=parseInt(s,10),e.getParam("wpeditimage_html5_captions")||(s+=10),'<div class="mceTemp"><dl id="'+i+'" class="wp-caption '+o+c+'" style="width: '+s+'px"><dt class="wp-caption-dt">'+r+'</dt><dd class="wp-caption-dd">'+d+"</dd></dl></div>"):n})}function a(e){return e.replace(/<div (?:id="attachment_|class="mceTemp)[^>]*>([\s\S]+?)<\/div>/g,function(e,t){var a="";return-1===t.indexOf("<img ")?(a=t.match(/<dd [^>]+>([\s\S]+?)<\/dd>/i),a&&a[1]?"<p>"+a[1]+"</p>":""):(a=t.replace(/<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>/gi,function(e,t,a,n){var i,o,c,d;return d=a.match(/width="([0-9]*)"/),d=d&&d[1]?d[1]:"",d&&n?(i=t.match(/id="([^"]*)"/),i=i&&i[1]?i[1]:"",o=t.match(/class="([^"]*)"/),o=o&&o[1]?o[1]:"",c=o.match(/align[a-z]+/i)||"alignnone",o=o.replace(/wp-caption ?|align[a-z]+ ?/gi,""),o&&(o=' class="'+o+'"'),n=n.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")}),n=n.replace(/\s*\n\s*/g,"<br />"),'[caption id="'+i+'" align="'+c+'" width="'+d+'"'+o+"]"+a+" "+n+"[/caption]"):a}),0!==a.indexOf("[caption")&&(a=t.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2")),a)})}function n(t){var a,n,i,o,c,d,r,s,l=[],p=e.dom,m=/^\d+$/;return i={attachment_id:!1,size:"custom",caption:"",align:"none",extraClasses:"",link:!1,linkUrl:"",linkClassName:"",linkTargetBlank:!1,linkRel:"",title:""},i.url=p.getAttrib(t,"src"),i.alt=p.getAttrib(t,"alt"),i.title=p.getAttrib(t,"title"),r=p.getAttrib(t,"width"),s=p.getAttrib(t,"height"),(!m.test(r)||parseInt(r,10)<1)&&(r=t.naturalWidth||t.width),(!m.test(s)||parseInt(s,10)<1)&&(s=t.naturalHeight||t.height),i.customWidth=i.width=r,i.customHeight=i.height=s,a=tinymce.explode(t.className," "),n=[],tinymce.each(a,function(e){/^wp-image/.test(e)?i.attachment_id=parseInt(e.replace("wp-image-",""),10):/^align/.test(e)?i.align=e.replace("align",""):/^size/.test(e)?i.size=e.replace("size-",""):n.push(e)}),i.extraClasses=n.join(" "),o=p.getParents(t,".wp-caption"),o.length&&(o=o[0],a=o.className.split(" "),tinymce.each(a,function(e){/^align/.test(e)?i.align=e.replace("align",""):e&&"wp-caption"!==e&&l.push(e)}),i.captionClassName=l.join(" "),c=p.select("dd.wp-caption-dd",o),c.length&&(c=c[0],i.caption=e.serializer.serialize(c).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,""))),t.parentNode&&"A"===t.parentNode.nodeName&&(d=t.parentNode,i.linkUrl=p.getAttrib(d,"href"),i.linkTargetBlank="_blank"===p.getAttrib(d,"target")?!0:!1,i.linkRel=p.getAttrib(d,"rel"),i.linkClassName=d.className),i}function i(e){return e&&!(!e.textContent&&!e.innerText)}function o(t,a){var n,o,c,d,s,l,p,m,g,u,h,w,f,v,N,C,b=e.dom;n=tinymce.explode(a.extraClasses," "),n||(n=[]),a.caption||n.push("align"+a.align),a.attachment_id&&(n.push("wp-image-"+a.attachment_id),a.size&&"custom"!==a.size&&n.push("size-"+a.size)),v=a.width,N=a.height,"custom"===a.size&&(v=a.customWidth,N=a.customHeight),w={src:a.url,width:v||null,height:N||null,alt:a.alt,title:a.title||null,"class":n.join(" ")||null},b.setAttribs(t,w),f={href:a.linkUrl,rel:a.linkRel||null,target:a.linkTargetBlank?"_blank":null,"class":a.linkClassName||null},t.parentNode&&"A"===t.parentNode.nodeName&&!i(t.parentNode)?a.linkUrl?b.setAttribs(t.parentNode,f):b.remove(t.parentNode,!0):a.linkUrl&&((p=b.getParent(t,"a"))&&b.insertAfter(t,p),p=b.create("a",f),t.parentNode.insertBefore(p,t),p.appendChild(t)),m=e.dom.getParent(t,".mceTemp"),c=t.parentNode&&"A"===t.parentNode.nodeName&&!i(t.parentNode)?t.parentNode:t,a.caption?(h=a.attachment_id?"attachment_"+a.attachment_id:null,C="align"+(a.align||"none"),o="wp-caption "+C,a.captionClassName&&(o+=" "+a.captionClassName.replace(/[<>&]+/g,"")),e.getParam("wpeditimage_html5_captions")||(v=parseInt(v,10),v+=10),m?(u=b.select("dl.wp-caption",m),u.length&&b.setAttribs(u,{id:h,"class":o,style:"width: "+v+"px"}),g=b.select(".wp-caption-dd",m),g.length&&b.setHTML(g[0],a.caption)):(h=h?'id="'+h+'" ':"",d="<dl "+h+'class="'+o+'" style="width: '+v+'px"><dt class="wp-caption-dt">'+b.getOuterHTML(c)+'</dt><dd class="wp-caption-dd">'+a.caption+"</dd></dl>",(s=b.getParent(c,"p"))?(l=b.create("div",{"class":"mceTemp"},d),s.parentNode.insertBefore(l,s),b.remove(c),b.isEmpty(s)&&b.remove(s)):b.setOuterHTML(c,'<div class="mceTemp">'+d+"</div>"))):m&&(s=b.create("p"),m.parentNode.insertBefore(s,m),s.appendChild(c),b.remove(m)),wp.media.events&&wp.media.events.trigger("editor:image-update",{editor:e,metadata:a,image:t}),e.nodeChanged(),r(t)}function c(t){var a,i,c;return"undefined"!=typeof wp&&wp.media?(c=n(t),wp.media.events.trigger("editor:image-edit",{editor:e,metadata:c,image:t}),a=wp.media({frame:"image",state:"image-details",metadata:c}),wp.media.events.trigger("editor:frame-create",{frame:a}),i=function(n){e.focus(),e.undoManager.transact(function(){o(t,n)}),a.detach()},a.state("image-details").on("update",i),a.state("replace-image").on("replace",i),a.on("close",function(){e.focus(),a.detach(),u=!1}),a.open(),void 0):(e.execCommand("mceImage"),void 0)}function d(t){var a;"DIV"===t.nodeName&&e.dom.hasClass(t,"mceTemp")?a=t:("IMG"===t.nodeName||"DT"===t.nodeName||"A"===t.nodeName)&&(a=e.dom.getParent(t,"div.mceTemp")),a?(a.nextSibling?e.selection.select(a.nextSibling):a.previousSibling?e.selection.select(a.previousSibling):e.selection.select(a.parentNode),e.selection.collapse(!0),e.dom.remove(a)):e.dom.remove(t),s(),e.nodeChanged(),e.undoManager.add()}function r(t){var a,n,i,o,c=e.dom;s(),t&&"IMG"===t.nodeName&&!l(t)&&(c.setAttrib(t,"data-wp-imgselect",1),a=c.getRect(t),n='<i class="dashicons dashicons-edit edit" data-mce-bogus="all"></i><i class="dashicons dashicons-no-alt remove" data-mce-bogus="all"></i>',i=c.create("p",{id:"wp-image-toolbar","data-mce-bogus":"all",contenteditable:!1},n),o=e.rtl?a.x+a.w-82:a.x,e.getBody().appendChild(i),c.setStyles(i,{top:a.y,left:o}),g=!0)}function s(){var t=e.dom.get("wp-image-toolbar");t&&e.dom.remove(t),e.dom.setAttrib(e.dom.select("img[data-wp-imgselect]"),"data-wp-imgselect",null),u=!1,g=!1}function l(t){var a=e.dom;return a.hasClass(t,"mceItem")||a.getAttrib(t,"data-mce-placeholder")||a.getAttrib(t,"data-mce-object")?!0:!1}function p(e){return e&&"I"===e.nodeName&&"wp-image-toolbar"===e.parentNode.id}function m(t){var a,n=t.target,i=e.dom;t.button&&t.button>1||(p(n)?(a=i.select("img[data-wp-imgselect]")[0],a&&(e.selection.select(a),i.hasClass(n,"remove")?d(a):i.hasClass(n,"edit")&&(u||(c(a),u=!0))),t.preventDefault()):"IMG"!==n.nodeName||e.dom.getAttrib(n,"data-wp-imgselect")||l(n)?"IMG"!==n.nodeName&&s():r(n))}var g=!1,u=!1;return"ontouchend"in document&&e.on("click",function(e){var t=e.target;u&&"IMG"===t.nodeName&&e.preventDefault(),p(t)&&(e.preventDefault(),e.stopPropagation())}),e.on("mouseup touchend",m),e.on("init",function(){var t=e.dom,a=e.getParam("wpeditimage_html5_captions")?"html5-captions":"html4-captions";t.addClass(e.getBody(),a),e.on("wpLoadImageForm",function(t){if(!e.getParam("wpeditimage_disable_captions")){var a={type:"textbox",flex:1,name:"caption",minHeight:60,multiline:!0,scroll:!0,label:"Image caption"};t.data.splice(t.data.length-1,0,a)}}),e.on("wpNewImageRefresh",function(e){var a,n;(a=t.getParent(e.node,"dl.wp-caption"))&&(a.style.width||(n=parseInt(e.node.clientWidth,10)+10,n=n?n+"px":"50%",t.setStyle(a,"width",n)))}),e.on("wpImageFormSubmit",function(a){var n,i,o,c,d,r=a.imgData.data,s=a.imgData.node,l=a.imgData.caption,p="",m="",g="";return r.id="__wp-temp-img-id",a.imgData.cancel=!0,r.style||(r.style=null),r.src?(l&&(l=l.replace(/\r\n|\r/g,"\n").replace(/<\/?[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")}),l=l.replace(/(<br[^>]*>)\s*\n\s*/g,"$1").replace(/\s*\n\s*/g,"<br />")),s?(d=s.id||null,t.setAttribs(s,r),n=t.getParent(s,"dl.wp-caption"),l?n?(i=t.select("dd.wp-caption-dd",n)[0])&&(i.innerHTML=l):(s.className&&(p=s.className.match(/wp-image-([0-9]+)/),m=s.className.match(/align(left|right|center|none)/)),m?(m=m[0],s.className=s.className.replace(/align(left|right|center|none)/g,"")):m="alignnone",m=' class="wp-caption '+m+'"',p&&(p=' id="attachment_'+p[1]+'"'),g=r.width||s.clientWidth,g&&(g=parseInt(g,10),e.getParam("wpeditimage_html5_captions")||(g+=10),g=' style="width: '+g+'px"'),s.parentNode&&"A"===s.parentNode.nodeName?(c=t.getOuterHTML(s.parentNode),o=s.parentNode):(c=t.getOuterHTML(s),o=s),c="<dl "+p+m+g+'><dt class="wp-caption-dt">'+c+'</dt><dd class="wp-caption-dd">'+l+"</dd></dl>",(i=t.getParent(s,"p"))?(n=t.create("div",{"class":"mceTemp"},c),t.insertAfter(n,i),e.selection.select(n),e.nodeChanged(),t.remove(o),t.isEmpty(i)&&t.remove(i)):e.selection.setContent('<div class="mceTemp">'+c+"</div>")):n&&(c="A"===s.parentNode.nodeName?t.getOuterHTML(s.parentNode):t.getOuterHTML(s),i=t.create("p",{},c),t.insertAfter(i,n.parentNode),e.selection.select(i),e.nodeChanged(),t.remove(n.parentNode))):(c=t.createHTML("img",r),l?(o=e.selection.getNode(),r.width&&(g=parseInt(r.width,10),e.getParam("wpeditimage_html5_captions")||(g+=10),g=' style="width: '+g+'px"'),c='<dl class="wp-caption alignnone"'+g+'><dt class="wp-caption-dt">'+c+'</dt><dd class="wp-caption-dd">'+l+"</dd></dl>",i="P"===o.nodeName?o:t.getParent(o,"p"),i&&"P"===i.nodeName?(n=t.create("div",{"class":"mceTemp"},c),i.parentNode.insertBefore(n,i),e.selection.select(n),e.nodeChanged(),t.isEmpty(i)&&t.remove(i)):e.selection.setContent('<div class="mceTemp">'+c+"</div>")):e.selection.setContent(c)),s=t.get("__wp-temp-img-id"),t.setAttrib(s,"id",d),a.imgData.node=s,void 0):(s&&((n=t.getParent(s,"div.mceTemp"))?t.remove(n):"A"===s.parentNode.nodeName?t.remove(s.parentNode):t.remove(s),e.nodeChanged()),void 0)}),e.on("wpLoadImageData",function(a){var n,i=a.imgData.data,o=a.imgData.node;(n=t.getParent(o,"dl.wp-caption"))&&(n=t.select("dd.wp-caption-dd",n)[0],n&&(i.caption=e.serializer.serialize(n).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,"")))}),t.bind(e.getDoc(),"dragstart",function(a){var n=e.selection.getNode();"IMG"===n.nodeName&&t.getParent(n,".wp-caption")&&a.preventDefault(),s()}),tinymce.Env.ie&&tinymce.Env.ie>10&&(t.bind(e.getBody(),"mscontrolselect",function(a){"IMG"===a.target.nodeName&&t.getParent(a.target,".wp-caption")?e.getBody().focus():"DL"===a.target.nodeName&&t.hasClass(a.target,"wp-caption")&&a.target.focus()}),e.on("click",function(a){"IMG"===a.target.nodeName&&t.getAttrib(a.target,"data-wp-imgselect")&&t.getParent(a.target,"dl.wp-caption")&&e.getBody().focus()}))}),e.on("ObjectResized",function(t){var a=t.target;"IMG"===a.nodeName&&e.undoManager.transact(function(){var n,i,o=e.dom;a.className=a.className.replace(/\bsize-[^ ]+/,""),(n=o.getParent(a,".wp-caption"))&&(i=t.width||o.getAttrib(a,"width"),i&&(i=parseInt(i,10),e.getParam("wpeditimage_html5_captions")||(i+=10),o.setStyle(n,"width",i+"px"))),r(a)})}),e.on("BeforeExecCommand",function(t){var a,n,i,o,c=t.command,d=e.dom;"mceInsertContent"===c?(a=d.getParent(e.selection.getNode(),"div.mceTemp"))&&(n=d.create("p"),d.insertAfter(n,a),e.selection.setCursorLocation(n,0),e.nodeChanged()):("JustifyLeft"===c||"JustifyRight"===c||"JustifyCenter"===c)&&(a=e.selection.getNode(),o=c.substr(7).toLowerCase(),o="align"+o,i=d.getParent(a,"dl.wp-caption"),s(),i&&(d.hasClass(i,o)?(d.removeClass(i,o),d.addClass(i,"alignnone")):(i.className=i.className.replace(/align[^ ]+/g,""),d.addClass(i,o)),"IMG"===a.nodeName&&e.nodeChanged(),t.preventDefault()),"IMG"===a.nodeName&&(d.hasClass(a,o)?d.addClass(a,"alignnone"):d.removeClass(a,"alignnone")))}),e.on("keydown",function(t){var a,n,i,o,c=e.selection,r=t.keyCode,l=e.dom,p=tinymce.util.VK;if(r===p.ENTER)a=c.getNode(),n=l.getParent(a,"div.mceTemp"),n&&(l.events.cancel(t),tinymce.each(l.select("dt, dd",n),function(e){l.isEmpty(e)&&l.remove(e)}),o=tinymce.Env.ie&&tinymce.Env.ie<11?"":'<br data-mce-bogus="1" />',i=l.create("p",null,o),"DD"===a.nodeName?l.insertAfter(i,n):n.parentNode.insertBefore(i,n),e.nodeChanged(),c.setCursorLocation(i,0));else if(r===p.DELETE||r===p.BACKSPACE){if(a=c.getNode(),"DIV"===a.nodeName&&l.hasClass(a,"mceTemp")?n=a:("IMG"===a.nodeName||"DT"===a.nodeName||"A"===a.nodeName)&&(n=l.getParent(a,"div.mceTemp")),n)return l.events.cancel(t),d(a),!1;s()}if(g){if(t.ctrlKey||t.metaKey||t.altKey||48>r&&r!==p.SPACEBAR)return;s()}}),e.on("mousedown",function(e){p(e.target)?tinymce.Env.ie&&e.preventDefault():"IMG"!==e.target.nodeName&&s()}),e.on("BeforeAddUndo",function(e){e.level.content=e.level.content.replace(/ data-wp-imgselect="1"/g,"")}),tinymce.Env.gecko&&e.on("undo redo",function(){"IMG"===e.selection.getNode().nodeName&&e.selection.collapse()}),e.on("cut wpview-selected",function(){s()}),e.wpSetImgCaption=function(e){return t(e)},e.wpGetImgCaption=function(e){return a(e)},e.on("BeforeSetContent",function(t){"raw"!==t.format&&(t.content=e.wpSetImgCaption(t.content))}),e.on("PostProcess",function(t){t.get&&(t.content=e.wpGetImgCaption(t.content),t.content=t.content.replace(/ data-wp-imgselect="1"/g,""))}),{_do_shcode:t,_get_shcode:a}});