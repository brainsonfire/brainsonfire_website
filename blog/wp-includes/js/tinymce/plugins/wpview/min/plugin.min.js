tinymce.PluginManager.add("wpview",function(e){function t(e){return n(e,"wpview-wrap")}function n(e,t){for(;e&&e.parentNode;){if(e.className&&-1!==(" "+e.className+" ").indexOf(" "+t+" "))return e;e=e.parentNode}return!1}function i(n){return(n=t(n))?window.decodeURIComponent(e.dom.getAttrib(n,"data-wpview-text")||""):""}function o(n,i){return n=t(n),n?(e.dom.setAttrib(n,"data-wpview-text",window.encodeURIComponent(i||"")),!0):!1}function r(e){e.stopPropagation()}function a(t,n){var i=t?"before":"after",o=t?0:1;d(),e.selection.setCursorLocation(e.dom.select(".wpview-selection-"+i,n)[0],o),e.nodeChanged()}function s(t,n,i){var o=e.dom,r=o.create("p");C.ie&&C.ie<11||(r.innerHTML='<br data-mce-bogus="1">'),n?t.parentNode.insertBefore(r,t):o.insertAfter(r,t),d(),n&&i===S.ENTER?a(n,t):e.selection.setCursorLocation(r,0),e.nodeChanged()}function c(t){e.undoManager.transact(function(){s(t),e.dom.remove(t)})}function l(t){var n,o=e.dom;t&&t!==f&&(e.getBody().focus(),d(),f=t,o.setAttrib(t,"data-mce-selected",1),n=o.create("div",{"class":"wpview-clipboard",contenteditable:"true"},i(t)),e.dom.select(".wpview-body",t)[0].appendChild(n),o.bind(n,"beforedeactivate focusin focusout",r),o.bind(f,"beforedeactivate focusin focusout",r),N?e.selection.select(n):e.selection.select(n,!0),e.nodeChanged(),e.fire("wpview-selected",t))}function d(){var t,n=e.dom;f&&(t=e.dom.select(".wpview-clipboard",f)[0],n.unbind(t),n.remove(t),n.unbind(f,"beforedeactivate focusin focusout click mouseup",r),n.setAttrib(f,"data-mce-selected",null)),f=null}function u(e){return e.replace(/<div[^>]+data-wpview-text=\"([^"]+)"[^>]*>[\s\S]+?wpview-selection-after[^>]+>(?:&nbsp;|\u00a0)*<\/p><\/div>/g,"$1")}function p(e){return 47>=e&&e!==S.SPACEBAR&&e!==S.ENTER&&e!==S.DELETE&&e!==S.BACKSPACE&&(37>e||e>40)||e>=224||e>=144&&150>=e||e>=91&&93>=e||e>=112&&135>=e}var f,v,g,w,m,b,C=tinymce.Env,S=tinymce.util.VK,y=tinymce.dom.TreeWalker,x=!1,h=!0,E=function(){return!1},N=/iPad|iPod|iPhone/.test(navigator.userAgent);return"undefined"!=typeof wp&&wp.mce?(e.on("BeforeAddUndo",function(e){e.lastLevel&&u(e.level.content)===u(e.lastLevel.content)&&e.preventDefault()}),e.on("BeforeSetContent",function(t){var n;t.content&&(f&&c(f),n=e.selection.getNode(),(!t.content.match(/^\s*(https?:\/\/[^\s"]+)\s*$/i)||"P"===n.nodeName&&n.parentNode===e.getBody()&&e.dom.isEmpty(n))&&(t.content=wp.mce.views.toViews(t.content)))}),e.on("SetContent",function(){wp.mce.views.render()}),e.on("click",function(n){var i,o=n.clientX,r=n.clientY,s=e.getBody(),c=s.getBoundingClientRect(),l=s.firstChild,d=l.getBoundingClientRect(),u=s.lastChild,p=u.getBoundingClientRect();r<d.top&&(i=t(l))?(a(!0,i),n.preventDefault()):r>p.bottom&&(i=t(u))?(a(!1,i),n.preventDefault()):tinymce.each(e.dom.select(".wpview-wrap"),function(e){var t=e.getBoundingClientRect();return r>=t.top&&r<=t.bottom?(o<c.left?(a(!0,e),n.preventDefault()):o>c.right&&(a(!1,e),n.preventDefault()),void 0):void 0})}),e.on("init",function(){var n=!1,i=e.selection,o=window.MutationObserver||window.WebKitMutationObserver;e.on("BeforeSetContent",function(){var n,o,r=t(i.getNode());r&&(!r.nextSibling||t(r.nextSibling)?(o=e.getDoc().createTextNode(""),e.dom.insertAfter(o,r)):(n=new y(r.nextSibling,r.nextSibling),o=n.next()),i.select(o),i.collapse(!0))}),e.dom.bind(e.getDoc(),"touchmove",function(){n=!0}),e.on("mousedown mouseup click touchend",function(i){var o=t(i.target);if(h=!1,o){if(i.stopImmediatePropagation(),i.preventDefault(),!("touchend"!==i.type&&"mousedown"!==i.type||i.metaKey||i.ctrlKey)){if(e.dom.hasClass(i.target,"edit"))return wp.mce.views.edit(o),e.focus(),!1;if(e.dom.hasClass(i.target,"remove"))return c(o),!1}return"touchend"===i.type&&n?n=!1:l(o),!1}("touchend"===i.type||"mousedown"===i.type)&&d(),"touchend"===i.type&&n&&(n=!1)},!0),o&&new o(function(){e.fire("wp-body-class-change")}).observe(e.getBody(),{attributes:!0,attributeFilter:["class"]})}),e.on("PreProcess",function(t){tinymce.each(e.dom.select("div[data-wpview-text]",t.node),function(e){e.textContent=e.innerText="Â "})}),e.on("PostProcess",function(e){e.content&&(e.content=e.content.replace(/<div [^>]*?data-wpview-text="([^"]*)"[^>]*>[\s\S]*?<\/div>/g,function(e,t){return t?"<p>"+window.decodeURIComponent(t)+"</p>":""}))}),e.on("keydown",function(n){var i,o,r,u,v,w,m,b=n.keyCode,C=e.dom,y=e.selection;if(f){if((n.metaKey||n.ctrlKey)&&b!==S.BACKSPACE&&86!==b||b>=112&&123>=b)return(n.metaKey||n.ctrlKey)&&88===b&&(x=f),void 0;if(o=t(y.getNode()),o!==f)return d(),void 0;b===S.LEFT?(a(!0,o),n.preventDefault()):b===S.UP?(o.previousSibling?t(o.previousSibling)?a(!0,o.previousSibling):(d(),y.select(o.previousSibling,!0),y.collapse()):a(!0,o),n.preventDefault()):b===S.RIGHT?(a(!1,o),n.preventDefault()):b===S.DOWN?(o.nextSibling?t(o.nextSibling)?a(!1,o.nextSibling):(d(),y.setCursorLocation(o.nextSibling,0)):a(!1,o),n.preventDefault()):p(b)||(c(f),(b===S.ENTER||b===S.DELETE||b===S.BACKSPACE)&&n.preventDefault())}else{if(n.metaKey||n.ctrlKey||b>=112&&123>=b)return;if(i=y.getNode(),g=i,o=t(i),y.isCollapsed()||(v=y.getRng(),(o=t(v.endContainer))?(w=v.cloneRange(),y.select(o.previousSibling,!0),y.collapse(),m=y.getRng(),w.setEnd(m.endContainer,m.endOffset),y.setRng(w)):(o=t(v.startContainer))&&(w=v.cloneRange(),w.setStart(o.nextSibling,0),y.setRng(w))),!o)return n.keyCode===S.BACKSPACE&&(e.dom.isEmpty(i)?(o=t(i.previousSibling))&&(a(!1,o),e.dom.remove(i),n.preventDefault()):(v=y.getRng())&&0===v.startOffset&&0===v.endOffset&&(o=t(i.previousSibling))&&(a(!1,o),n.preventDefault())),void 0;if(!(r=C.hasClass(o,"wpview-selection-before"))&&!(u=C.hasClass(o,"wpview-selection-after")))return;if(p(b))return;u&&b===S.UP||r&&b===S.BACKSPACE?(o.previousSibling?t(o.previousSibling)?a(!1,o.previousSibling):C.isEmpty(o.previousSibling)&&b===S.BACKSPACE?C.remove(o.previousSibling):(y.select(o.previousSibling,!0),y.collapse()):a(!0,o),n.preventDefault()):!u||b!==S.DOWN&&b!==S.RIGHT?!r||b!==S.UP&&b!==S.LEFT?r&&b===S.DOWN?(o.nextSibling?t(o.nextSibling)?a(!0,o.nextSibling):y.setCursorLocation(o.nextSibling,0):a(!1,o),n.preventDefault()):u&&b===S.LEFT||r&&b===S.RIGHT?(l(o),n.preventDefault()):u&&b===S.BACKSPACE?(c(o),n.preventDefault()):u?s(o):r&&s(o,!0,b):(o.previousSibling&&(t(o.previousSibling)?a(b===S.UP,o.previousSibling):(y.select(o.previousSibling,!0),y.collapse())),n.preventDefault()):(o.nextSibling&&(t(o.nextSibling)?a(b===S.RIGHT,o.nextSibling):y.setCursorLocation(o.nextSibling,0)),n.preventDefault()),b===S.ENTER&&n.preventDefault()}}),e.on("keyup",function(){x&&(c(x),x=!1)}),e.on("focus",function(){var n;m=!0,e.dom.addClass(e.getBody(),"has-focus"),h&&(n=t(e.getBody().firstChild))&&a(!0,n),h=!1}),e.on("blur",function(){m=!1,e.dom.removeClass(e.getBody(),"has-focus")}),e.on("NodeChange",function(i){var o=e.dom,r=e.dom.select(".wpview-wrap"),s=i.element.className,c=t(i.element),l=g;if(g=!1,clearInterval(v),tinymce.each(r,function(e){e.className&&(e.className=e.className.replace(/ ?\bwpview-(?:selection-before|selection-after|cursor-hide)\b/g,""))}),m&&c)if("wpview-selection-before"!==s&&"wpview-selection-after"!==s||!e.selection.isCollapsed())n(i.element,"wpview-clipboard")||w||(d(),w++,a(!0,c));else{if(w=0,d(),l===c.previousSibling)return a(!0,c),void 0;if(l===c.nextSibling)return a(!1,c),void 0;o.addClass(c,s),v=setInterval(function(){o.hasClass(c,"wpview-cursor-hide")?o.removeClass(c,"wpview-cursor-hide"):o.addClass(c,"wpview-cursor-hide")},500)}}),e.on("BeforeExecCommand",function(){var n,i=e.selection.getNode();i&&("wpview-selection-before"===i.className||"wpview-selection-after"===i.className)&&(n=t(i))&&(s(n),b=n)}),e.on("ExecCommand",function(){var t,n;f&&(t=f,d(),l(t)),b&&(n=b.nextSibling,n&&"P"===n.nodeName&&e.dom.isEmpty(n)&&(e.dom.remove(n),a(!1,b)),b=!1)}),e.on("ResolveName",function(n){e.dom.hasClass(n.target,"wpview-wrap")?(n.name=e.dom.getAttrib(n.target,"data-wpview-type")||"wpview",n.stopPropagation()):t(n.target)&&(n.preventDefault(),n.stopPropagation())}),{getViewText:i,setViewText:o,getView:t}):{getViewText:E,setViewText:E,getView:E}});