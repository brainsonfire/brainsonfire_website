!function(i){var t=window.imageEdit={iasapi:{},hold:{},postid:"",_view:!1,intval:function(i){return 0|i},setDisabled:function(t,e){e?(t.removeClass("disabled"),i("input",t).removeAttr("disabled")):(t.addClass("disabled"),i("input",t).prop("disabled",!0))},init:function(t){var e=this,a=i("#image-editor-"+e.postid),o=e.intval(i("#imgedit-x-"+t).val()),n=e.intval(i("#imgedit-y-"+t).val());e.postid!==t&&a.length&&e.close(e.postid),e.hold.w=e.hold.ow=o,e.hold.h=e.hold.oh=n,e.hold.xy_ratio=o/n,e.hold.sizer=parseFloat(i("#imgedit-sizer-"+t).val()),e.postid=t,i("#imgedit-response-"+t).empty(),i('input[type="text"]',"#imgedit-panel-"+t).keypress(function(t){var e=t.keyCode;return e>36&&41>e&&i(this).blur(),13===e?(t.preventDefault(),t.stopPropagation(),!1):void 0})},toggleEditor:function(t,e){var a=i("#imgedit-wait-"+t);e?a.height(i("#imgedit-panel-"+t).height()).fadeIn("fast"):a.fadeOut("fast")},toggleHelp:function(t){return i(t).parents(".imgedit-group-top").toggleClass("imgedit-help-toggled").find(".imgedit-help").slideToggle("fast"),!1},getTarget:function(t){return i('input[name="imgedit-target-'+t+'"]:checked',"#imgedit-save-target-"+t).val()||"full"},scaleChanged:function(t,e){var a=i("#imgedit-scale-width-"+t),o=i("#imgedit-scale-height-"+t),n=i("#imgedit-scale-warn-"+t),s="",d="";e?(d=""!==a.val()?Math.round(a.val()/this.hold.xy_ratio):"",o.val(d)):(s=""!==o.val()?Math.round(o.val()*this.hold.xy_ratio):"",a.val(s)),d&&d>this.hold.oh||s&&s>this.hold.ow?n.css("visibility","visible"):n.css("visibility","hidden")},getSelRatio:function(t){var e=this.hold.w,a=this.hold.h,o=this.intval(i("#imgedit-crop-width-"+t).val()),n=this.intval(i("#imgedit-crop-height-"+t).val());return o&&n?o+":"+n:e&&a?e+":"+a:"1:1"},filterHistory:function(t,e){var a,o,n,s,d=i("#imgedit-history-"+t).val(),r=[];if(""!==d){if(d=JSON.parse(d),a=this.intval(i("#imgedit-undone-"+t).val()),a>0)for(;a>0;)d.pop(),a--;if(e){if(!d.length)return this.hold.w=this.hold.ow,this.hold.h=this.hold.oh,"";n=d[d.length-1],n=n.c||n.r||n.f||!1,n&&(this.hold.w=n.fw,this.hold.h=n.fh)}for(o in d)s=d[o],s.hasOwnProperty("c")?r[o]={c:{x:s.c.x,y:s.c.y,w:s.c.w,h:s.c.h}}:s.hasOwnProperty("r")?r[o]={r:s.r.r}:s.hasOwnProperty("f")&&(r[o]={f:s.f.f});return JSON.stringify(r)}return""},refreshEditor:function(e,a,o){var n,s,d=this;d.toggleEditor(e,1),n={action:"imgedit-preview",_ajax_nonce:a,postid:e,history:d.filterHistory(e,1),rand:d.intval(1e6*Math.random())},s=i('<img id="image-preview-'+e+'" />').on("load",function(){var a,n,d=i("#imgedit-crop-"+e),r=t;d.empty().append(s),a=Math.max(r.hold.w,r.hold.h),n=Math.max(i(s).width(),i(s).height()),r.hold.sizer=a>n?n/a:1,r.initCrop(e,s,d),r.setCropSelection(e,0),"undefined"!=typeof o&&null!==o&&o(),i("#imgedit-history-"+e).val()&&"0"===i("#imgedit-undone-"+e).val()?i("input.imgedit-submit-btn","#imgedit-panel-"+e).removeAttr("disabled"):i("input.imgedit-submit-btn","#imgedit-panel-"+e).prop("disabled",!0),r.toggleEditor(e,0)}).on("error",function(){i("#imgedit-crop-"+e).empty().append('<div class="error"><p>'+imageEditL10n.error+"</p></div>"),d.toggleEditor(e,0)}).attr("src",ajaxurl+"?"+i.param(n))},action:function(t,e,a){var o,n,s,d,r,l=this;if(l.notsaved(t))return!1;if(o={action:"image-editor",_ajax_nonce:e,postid:t},"scale"===a){if(n=i("#imgedit-scale-width-"+t),s=i("#imgedit-scale-height-"+t),d=l.intval(n.val()),r=l.intval(s.val()),1>d)return n.focus(),!1;if(1>r)return s.focus(),!1;if(d===l.hold.ow||r===l.hold.oh)return!1;o["do"]="scale",o.fwidth=d,o.fheight=r}else{if("restore"!==a)return!1;o["do"]="restore"}l.toggleEditor(t,1),i.post(ajaxurl,o,function(e){i("#image-editor-"+t).empty().append(e),l.toggleEditor(t,0),l._view&&l._view.refresh()})},save:function(e,a){var o,n=this.getTarget(e),s=this.filterHistory(e,0),d=this;return""===s?!1:(this.toggleEditor(e,1),o={action:"image-editor",_ajax_nonce:a,postid:e,history:s,target:n,context:i("#image-edit-context").length?i("#image-edit-context").val():null,"do":"save"},i.post(ajaxurl,o,function(a){var o=JSON.parse(a);return o.error?(i("#imgedit-response-"+e).html('<div class="error"><p>'+o.error+"</p></div>"),t.close(e),void 0):(o.fw&&o.fh&&i("#media-dims-"+e).html(o.fw+" &times; "+o.fh),o.thumbnail&&i(".thumbnail","#thumbnail-head-"+e).attr("src",""+o.thumbnail),o.msg&&i("#imgedit-response-"+e).html('<div class="updated"><p>'+o.msg+"</p></div>"),d._view?d._view.save():t.close(e),void 0)}),void 0)},open:function(t,e,a){this._view=a;var o,n,s=i("#image-editor-"+t),d=i("#media-head-"+t),r=i("#imgedit-open-btn-"+t),l=r.siblings(".spinner");return r.prop("disabled",!0),l.show(),n={action:"image-editor",_ajax_nonce:e,postid:t,"do":"open"},o=i.ajax({url:ajaxurl,type:"post",data:n}).done(function(i){s.html(i),d.fadeOut("fast",function(){s.fadeIn("fast"),r.removeAttr("disabled"),l.hide()})})},imgLoaded:function(t){var e=i("#image-preview-"+t),a=i("#imgedit-crop-"+t);this.initCrop(t,e,a),this.setCropSelection(t,0),this.toggleEditor(t,0)},initCrop:function(e,a,o){var n,s=this,d=i("#imgedit-sel-width-"+e),r=i("#imgedit-sel-height-"+e);s.iasapi=i(a).imgAreaSelect({parent:o,instance:!0,handles:!0,keys:!0,minWidth:3,minHeight:3,onInit:function(t){n=i(t),n.next().css("position","absolute").nextAll(".imgareaselect-outer").css("position","absolute"),o.children().mousedown(function(i){var t,a,o=!1;i.shiftKey&&(t=s.iasapi.getSelection(),a=s.getSelRatio(e),o=t&&t.width&&t.height?t.width+":"+t.height:a),s.iasapi.setOptions({aspectRatio:o})})},onSelectStart:function(){t.setDisabled(i("#imgedit-crop-sel-"+e),1)},onSelectEnd:function(i,a){t.setCropSelection(e,a)},onSelectChange:function(i,e){var a=t.hold.sizer;d.val(t.round(e.width/a)),r.val(t.round(e.height/a))}})},setCropSelection:function(t,e){var a;return e=e||0,!e||e.width<3&&e.height<3?(this.setDisabled(i(".imgedit-crop","#imgedit-panel-"+t),0),this.setDisabled(i("#imgedit-crop-sel-"+t),0),i("#imgedit-sel-width-"+t).val(""),i("#imgedit-sel-height-"+t).val(""),i("#imgedit-selection-"+t).val(""),!1):(a={x:e.x1,y:e.y1,w:e.width,h:e.height},this.setDisabled(i(".imgedit-crop","#imgedit-panel-"+t),1),i("#imgedit-selection-"+t).val(JSON.stringify(a)),void 0)},close:function(t,e){return e=e||!1,e&&this.notsaved(t)?!1:(this.iasapi={},this.hold={},this._view?this._view.back():i("#image-editor-"+t).fadeOut("fast",function(){i("#media-head-"+t).fadeIn("fast"),i(this).empty()}),void 0)},notsaved:function(t){var e=i("#imgedit-history-"+t).val(),a=""!==e?JSON.parse(e):[],o=this.intval(i("#imgedit-undone-"+t).val());return o<a.length?confirm(i("#imgedit-leaving-"+t).html())?!1:!0:!1},addStep:function(t,e,a){for(var o=this,n=i("#imgedit-history-"+e),s=""!==n.val()?JSON.parse(n.val()):[],d=i("#imgedit-undone-"+e),r=o.intval(d.val());r>0;)s.pop(),r--;d.val(0),s.push(t),n.val(JSON.stringify(s)),o.refreshEditor(e,a,function(){o.setDisabled(i("#image-undo-"+e),!0),o.setDisabled(i("#image-redo-"+e),!1)})},rotate:function(t,e,a,o){return i(o).hasClass("disabled")?!1:(this.addStep({r:{r:t,fw:this.hold.h,fh:this.hold.w}},e,a),void 0)},flip:function(t,e,a,o){return i(o).hasClass("disabled")?!1:(this.addStep({f:{f:t,fw:this.hold.w,fh:this.hold.h}},e,a),void 0)},crop:function(t,e,a){var o=i("#imgedit-selection-"+t).val(),n=this.intval(i("#imgedit-sel-width-"+t).val()),s=this.intval(i("#imgedit-sel-height-"+t).val());return i(a).hasClass("disabled")||""===o?!1:(o=JSON.parse(o),o.w>0&&o.h>0&&n>0&&s>0&&(o.fw=n,o.fh=s,this.addStep({c:o},t,e)),void 0)},undo:function(t,e){var a=this,o=i("#image-undo-"+t),n=i("#imgedit-undone-"+t),s=a.intval(n.val())+1;o.hasClass("disabled")||(n.val(s),a.refreshEditor(t,e,function(){var e=i("#imgedit-history-"+t),n=""!==e.val()?JSON.parse(e.val()):[];a.setDisabled(i("#image-redo-"+t),!0),a.setDisabled(o,s<n.length)}))},redo:function(t,e){var a=this,o=i("#image-redo-"+t),n=i("#imgedit-undone-"+t),s=a.intval(n.val())-1;o.hasClass("disabled")||(n.val(s),a.refreshEditor(t,e,function(){a.setDisabled(i("#image-undo-"+t),!0),a.setDisabled(o,s>0)}))},setNumSelection:function(t){var e,a,o,n,s,d=i("#imgedit-sel-width-"+t),r=i("#imgedit-sel-height-"+t),l=this.intval(d.val()),h=this.intval(r.val()),g=i("#image-preview-"+t),v=g.height(),p=g.width(),c=this.hold.sizer,u=this.iasapi;return 1>l?(d.val(""),!1):1>h?(r.val(""),!1):(l&&h&&(e=u.getSelection())&&(n=e.x1+Math.round(l*c),s=e.y1+Math.round(h*c),a=e.x1,o=e.y1,n>p&&(a=0,n=p,d.val(Math.round(n/c))),s>v&&(o=0,s=v,r.val(Math.round(s/c))),u.setSelection(a,o,n,s),u.update(),this.setCropSelection(t,u.getSelection())),void 0)},round:function(i){var t;return i=Math.round(i),this.hold.sizer>.6?i:(t=i.toString().slice(-1),"1"===t?i-1:"9"===t?i+1:i)},setRatioSelection:function(t,e,a){var o,n,s=this.intval(i("#imgedit-crop-width-"+t).val()),d=this.intval(i("#imgedit-crop-height-"+t).val()),r=i("#image-preview-"+t).height();return this.intval(i(a).val())?(s&&d&&(this.iasapi.setOptions({aspectRatio:s+":"+d}),(o=this.iasapi.getSelection(!0))&&(n=Math.ceil(o.y1+(o.x2-o.x1)/(s/d)),n>r&&(n=r,e?i("#imgedit-crop-height-"+t).val(""):i("#imgedit-crop-width-"+t).val("")),this.iasapi.setSelection(o.x1,o.y1,o.x2,n),this.iasapi.update())),void 0):(i(a).val(""),void 0)}}}(jQuery);