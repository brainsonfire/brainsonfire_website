tinymce.PluginManager.add("wpgallery",function(e){function t(e){return e.replace(/\[gallery([^\]]*)\]/g,function(e){return n("wp-gallery",e)})}function n(e,t){return t=window.encodeURIComponent(t),'<img src="'+tinymce.Env.transparentSrc+'" class="wp-media mceItem '+e+'" data-wp-media="'+t+'" data-mce-resize="false" data-mce-placeholder="1" />'}function a(e){function t(e,t){return t=new RegExp(t+'="([^"]+)"').exec(e),t?window.decodeURIComponent(t[1]):""}return e.replace(/(?:<p(?: [^>]+)?>)*(<img [^>]+>)(?:<\/p>)*/g,function(e,n){var a=t(n,"data-wp-media");return a?"<p>"+a+"</p>":e})}function o(t){var n,a,o;"IMG"===t.nodeName&&"undefined"!=typeof wp&&wp.media&&(o=window.decodeURIComponent(e.dom.getAttrib(t,"data-wp-media")),e.dom.hasClass(t,"wp-gallery")&&wp.media.gallery&&(n=wp.media.gallery,a=n.edit(o),a.state("gallery-edit").on("update",function(o){var d=n.shortcode(o).string();e.dom.setAttrib(t,"data-wp-media",window.encodeURIComponent(d)),a.detach()})))}e.addCommand("WP_Gallery",function(){o(e.selection.getNode())}),e.on("mouseup",function(t){function n(){a.removeClass(a.select("img.wp-media-selected"),"wp-media-selected")}var a=e.dom,d=t.target;"IMG"===d.nodeName&&a.getAttrib(d,"data-wp-media")?2!==t.button&&(a.hasClass(d,"wp-media-selected")?o(d):(n(),a.addClass(d,"wp-media-selected"))):n()}),e.on("ResolveName",function(t){var n=e.dom,a=t.target;"IMG"===a.nodeName&&n.getAttrib(a,"data-wp-media")&&n.hasClass(a,"wp-gallery")&&(t.name="gallery")}),e.on("BeforeSetContent",function(n){e.plugins.wpview||(n.content=t(n.content))}),e.on("PostProcess",function(e){e.get&&(e.content=a(e.content))})});